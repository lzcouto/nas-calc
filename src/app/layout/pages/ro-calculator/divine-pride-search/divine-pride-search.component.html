<p-dialog
  header="Divine Pride Search"
  [draggable]="false"
  [resizable]="false"
  [modal]="true"
  [closeOnEscape]="true"
  [(visible)]="isShowSearchDialog"
  (onHide)="onDialogHide()"
  [style]="{ width: '75vw', height: '90vh', 'min-width': '750px' }"
>
  <div class="p-fluid grid grid-nogutter">
    <!-- Search Controls -->
    <div class="col-12 mb-3">
      <div class="flex align-items-end gap-2">
        <div class="flex-1">
          <label for="itemId" class="font-bold block mb-2">Item ID:</label>
          <p-inputNumber
            id="itemId"
            [(ngModel)]="itemId"
            placeholder="Enter Item ID (e.g. 5017)"
            [useGrouping]="false"
            [min]="1"
            class="w-full"
          ></p-inputNumber>
        </div>
        <div class="flex gap-2">
          <button
            pButton
            type="button"
            label="Search"
            icon="pi pi-search"
            class="p-button-info p-button-sm"
            (click)="onSearch()"
            [loading]="isLoading"
            [disabled]="!itemId || itemId <= 0"
          ></button>
          <button
            pButton
            type="button"
            label="Clear"
            icon="pi pi-times"
            class="p-button-secondary p-button-sm"
            (click)="onClearSearch()"
            [disabled]="!searchResult && !errorMessage"
          ></button>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="col-12 mb-3" *ngIf="errorMessage">
      <p-message severity="error" [text]="errorMessage"></p-message>
    </div>

    <!-- Loading Indicator -->
    <div class="col-12 mb-3 text-center" *ngIf="isLoading">
      <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>
      <p>Fetching item data from Divine Pride...</p>
    </div>

    <!-- Search Results -->
    <div class="col-12" *ngIf="searchResult && !isLoading">
      <div class="grid grid-nogutter">
        <!-- Divine Pride Style Item Display -->
        <div class="col-12 mb-3">
          <div class="divine-pride-item-card p-3 border-round">
            <!-- Item Header with Icon and Name -->
            <div class="flex align-items-center gap-3 mb-3">
              <div class="item-icon-container">
                <img 
                  [src]="'https://www.divine-pride.net/img/items/collection/LATAM/' + searchResult.id" 
                  [alt]="searchResult.name"
                  class="item-icon"
                  (error)="onImageError($event)"
                />
              </div>
              <div class="flex-1">
                <div class="flex align-items-center gap-2">
                  <img 
                    [src]="'https://www.divine-pride.net/img/items/item/LATAM/' + searchResult.id" 
                    [alt]="searchResult.name"
                    class="item-title-icon"
                    (error)="onTitleIconError($event)"
                  />
                  <h2 class="item-name m-0 text-primary">{{ searchResult.name }}</h2>
                </div>
                <p class="item-id m-0 text-sm text-color-secondary">{{ searchResult.id }} {{ searchResult.name }}</p>
              </div>
            </div>

            <!-- Item Description -->
            <div class="item-description mb-3 p-3 border-round surface-border">
              <ng-container *ngFor="let part of formattedDescription">
                <span 
                  *ngIf="part.isLineBreak"
                  [innerHTML]="part.text"
                ></span>
                <span 
                  *ngIf="!part.isLineBreak"
                  [class]="part.isHighlight ? 'item-highlight' : 'item-normal'"
                  [style.color]="part.color || '#ffffff'"
                >{{ part.text }}</span>
              </ng-container>
            </div>

            <!-- Item Stats Grid (Extracted from Description + API Data) -->
            <div class="grid grid-nogutter gap-2 item-stats">
              <!-- Left Column -->
              <div class="col-6">
                <!-- Type from description or API -->
                <div class="stat-item" *ngIf="extractedStats['type'] || searchResult.itemTypeId">
                  <span class="stat-label">Type:</span>
                  <span class="stat-value">{{ extractedStats['type'] || getItemTypeText(searchResult.itemTypeId) }}</span>
                </div>
                <!-- Attack from description or API -->
                <div class="stat-item" *ngIf="extractedStats['attack'] || searchResult.attack !== null">
                  <span class="stat-label">ATK:</span>
                  <span class="stat-value text-primary font-semibold">{{ extractedStats['attack'] || searchResult.attack }}</span>
                </div>
                <!-- Defense from description or API -->
                <div class="stat-item" *ngIf="extractedStats['defense'] || searchResult.defense !== null">
                  <span class="stat-label">DEF:</span>
                  <span class="stat-value text-primary font-semibold">{{ extractedStats['defense'] || searchResult.defense }}</span>
                </div>
                <!-- Weight from description -->
                <div class="stat-item" *ngIf="extractedStats['weight']">
                  <span class="stat-label">Weight:</span>
                  <span class="stat-value">{{ extractedStats['weight'] }}</span>
                </div>
              </div>
              
              <!-- Right Column -->
              <div class="col-6">
                <!-- Required Level from description or API -->
                <div class="stat-item" *ngIf="extractedStats['requiredLevel'] || searchResult.requiredLevel">
                  <span class="stat-label">Level required:</span>
                  <span class="stat-value">{{ extractedStats['requiredLevel'] || searchResult.requiredLevel }}</span>
                </div>
                <!-- Weapon Level from description -->
                <div class="stat-item" *ngIf="extractedStats['weaponLevel']">
                  <span class="stat-label">Weapon level:</span>
                  <span class="stat-value">{{ extractedStats['weaponLevel'] }}</span>
                </div>
                <!-- Item Level from API -->
                <div class="stat-item" *ngIf="searchResult.itemLevel">
                  <span class="stat-label">Item Level:</span>
                  <span class="stat-value">{{ searchResult.itemLevel }}</span>
                </div>
                <!-- Slots from API -->
                <div class="stat-item" *ngIf="searchResult.slots > 0">
                  <span class="stat-label">Slots:</span>
                  <span class="stat-value text-orange-500 font-semibold">{{ searchResult.slots }}</span>
                </div>
                <!-- Equip location from API -->
                <div class="stat-item" *ngIf="searchResult.location">
                  <span class="stat-label">Equip on:</span>
                  <span class="stat-value">{{ searchResult.location }}</span>
                </div>
              </div>
            </div>

            <!-- Classes and Effects (Full Width) -->
            <div class="mt-3" *ngIf="extractedStats['classes'] || extractedEffects.length > 0">
              <!-- Classes from description -->
              <div class="stat-item" *ngIf="extractedStats['classes']">
                <span class="stat-label">Classes:</span>
                <span class="stat-value">{{ extractedStats['classes'] }}</span>
              </div>

              <!-- Effects from description -->
              <div class="stat-item" *ngIf="extractedEffects.length > 0">
                <span class="stat-label">Effects:</span>
                <div class="stat-value">
                  <div *ngFor="let effect of extractedEffects" class="effect-item text-blue-400 font-semibold">
                    {{ effect }}
                  </div>
                </div>
              </div>
            </div>


          </div>
        </div>

        <!-- Formatted JSON Display -->
        <div class="col-12">
          <p-accordion [multiple]="false">
            <p-accordionTab header="Raw JSON Data">
              <pre class="p-3 border-round surface-ground text-sm overflow-auto" style="max-height: 400px; white-space: pre-wrap;">{{ formattedResult }}</pre>
            </p-accordionTab>
          </p-accordion>
        </div>
      </div>
    </div>

    <!-- Help Text -->
    <div class="col-12 mt-3" *ngIf="!searchResult && !isLoading && !errorMessage">
      <p-message severity="info">
        <div>
          <p><strong>How to use Divine Pride Search:</strong></p>
          <ul class="ml-3">
            <li>Enter an item ID number (e.g., 5017 for Bone Helm)</li>
            <li>Click "Search" to fetch item data from Divine Pride API</li>
            <li>View the formatted item information and raw JSON data</li>
            <li>Use "Clear" to reset the search</li>
          </ul>
        </div>
      </p-message>
    </div>
  </div>
</p-dialog> 