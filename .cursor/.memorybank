# Ragnarok Online Damage Calculator - Memory Bank

## Project Overview
- **Type**: TypeScript/Angular damage calculator for Ragnarok Online MMORPG
- **Framework**: Angular 16 with PrimeNG UI components
- **Architecture**: Complex multi-layered calculation engine with job class system
- **Scale**: 65+ job classes, 1,500+ line calculation engines, 20MB+ of game data
- **Language**: English (previously had Thai text, now fully translated)
- **Focus**: Streamlined, lean calculator focused on core damage calculation functionality
- **Version**: 0.2.0-BETA (latest version with Divine Pride API service integration)

## Recent Changes (Latest Update)
- **Divine Pride API Service Implementation (v0.2.0-BETA)**: Added external API integration for game data
  - **New API Service**: Implemented `DivinePrideService` with three main endpoints
    - `getSkill(skillId)` - Retrieve skill data from Divine Pride API
    - `getMonster(monsterId)` - Retrieve monster data from Divine Pride API  
    - `getItem(itemId)` - Retrieve item data from Divine Pride API
  - **Configuration**: Uses environment configuration with API key and host settings
    - Defaults to `bRO` server for Brazil Ragnarok Online
    - Uses `en-US` Accept-Language header for English responses
    - Environment-based API key management (`environment.local.ts`)
  - **TypeScript Models**: Complete type safety with Divine Pride API response models
    - `DivinePrideSkillModel` - Skill data with globalization support
    - `DivinePrideMonsterModel` - Monster stats, spawn locations, and skills
    - `DivinePrideItemModel` - Item properties, descriptions, and requirements
  - **Integration Tests**: Comprehensive test suite with real API calls (no mocking)
    - Tests all three endpoints with actual Ragnarok Online data
    - Error handling tests for invalid IDs and authentication
    - Custom test script: `npm run test:divine-pride`
    - Uses real game data: Fire Ball skill (ID: 17), Poring monster (ID: 1002), Bone Helm (ID: 5017)
  - **Service Architecture**: Follows existing project patterns and integrates with API service module
- **Navbar Clean-up & Footer References Migration (v0.1.4-BETA)**: Major UI reorganization for cleaner navbar
  - **References Migration**: Moved references button from navbar to footer right side to reduce navbar pollution
  - **Version Repositioning**: Moved version display from left side to right side of navbar for better balance
  - **Website Title Update**: Changed browser tab title to "Ragnarok Online LATAM Calculator"
  - **Footer Enhancement**: Added references functionality to footer while preserving existing attribution layout
  - **Icon Consistency Fix**: Implemented comprehensive CSS standardization for all topbar icons
    - All icons now use consistent 1.25rem (text-xl equivalent) sizing
    - Converted home button from p-tabMenu to regular pButton for consistency
    - Removed inconsistent size classes (text-xl, text-lg) from HTML
    - Created future-proof CSS rules to prevent icon size inconsistencies
  - **Code Cleanup**: Removed unused MenuItem arrays and tab-related properties from TypeScript
  - **Bundle Optimization**: Reduced main bundle size from 127.53 kB to 115.80 kB through code cleanup
- **Navbar UI Improvements & Translation Cleanup (v0.1.3-BETA)**: Major navbar redesign and complete Thai text translation
  - **Home Button Redesign**: Moved Calculator button to far left as home icon only (removed text label)
  - **Green Border Removal**: Eliminated the green selection bar from navbar buttons by removing border styling
  - **Improved Spacing**: Added proper spacing between search icon and "Items" text in navbar
  - **Settings Button Enhancement**: Increased cogwheel size and improved padding to prevent crushed appearance
  - **Footer Styling**: Made "NITROBLISSERINO ATTACK SQUAD @ ROLA" text bold and italic
  - **Complete Thai Translation**: Translated all remaining Thai text in codebase to English
    - Damage calculator penetration labels: 'เจาะเวท' → 'Magic Penetration', 'เจาะกาย' → 'Physical Penetration'
    - Utility options: Updated penetration race/class labels to English
    - StarEmperor skill: 'ตัวลอย' → 'Fusion Force'
    - Reference links: Translated Thai titles to English equivalents
    - Author names: Converted Thai names to English transliterations
    - **Final Thai Text Cleanup (Latest)**: Comprehensive sweep to remove all remaining Thai text
      - Calculator UI: 'อีก' → 'Need more', accuracy/penetration labels translated
      - Battle summary: All Thai labels ('แม่น', 'เจาะ') → English equivalents
      - Item search: 'ลด Cooldown' → 'Reduce Cooldown'
      - Job buffs: '[บิC4]' → '[BiC4]', penetration labels translated
      - Monster locations: All Thai location names translated to English
      - Code comments: Thai time references ('วินาที') → 'seconds'
      - Shared presets: All remaining Thai UI labels translated
  - **Layout Restructure**: Home button now uses separate homeItems array for icon-only display
  - **CSS Cleanup**: Removed problematic border styling that caused visual issues
- **Topbar Right-Side Positioning Fix (v0.1.2-BETA)**: Resolved positioning issue by utilizing layout-topbar-menu container
  - **Issue**: Calculator, Items, and Settings buttons were appearing in center despite flexbox attempts
  - **Root Cause**: Custom flexbox container was conflicting with existing `layout-topbar-menu` CSS positioning
  - **Solution**: Moved Calculator, Items, and Settings buttons into the purpose-built `layout-topbar-menu` div
  - **Result**: Right-side elements now properly align all the way to the right edge using existing layout system
  - **Technical**: Leveraged existing CSS instead of fighting it, simplified main container structure
- **Topbar Layout Reorganization (v0.1.0-BETA)**: Restructured topbar layout for better organization
  - **Left side**: Version, Bell icon (changelog), References button
  - **Right side**: Calculator navigation, Items search button, Settings cogwheel
  - Enhanced visual separation and improved user experience flow
  - Calculator navigation moved to the right side for better prominence
- **Footer Redesign**: Complete footer makeover
  - Removed PrimeNG logo image
  - Changed attribution to "by NITROBLISSERINO ATTACK SQUAD @ ROLA"
  - Added smaller subtitle crediting original work: "A fork of Tong Calc" (with hyperlink)
  - Implemented proper link styling with target="_blank" and security attributes
- **Changelog Synchronization**: Enhanced workflow with dual changelog system
  - **Bell Dialog**: Updated changelog in topbar component with recent changes
  - **CHANGELOG.md**: Synchronized entries to match bell dialog notifications
  - Both changelog sources now contain identical information for consistency
- **Versioning System**: Implemented semantic versioning for website development
  - **Current Version**: 0.1.4-BETA (MINOR update for navbar reorganization and UI improvements)
  - **Website-Adapted Rules**: MAJOR for UI redesigns/breaking changes, MINOR for new features/significant improvements, PATCH for fixes/cosmetic changes
  - **Automated Workflow**: Version bumping integrated into feature development process
- **Previous UI Reorganization**: Moved item search functionality and settings cogwheel to the topbar
  - Item search button now appears in the topbar with "Items" label and search icon
  - Settings cogwheel now appears in the topbar (far right) for scale and color configuration
  - Removed fixed-position buttons from their original locations
  - Added communication via LayoutService between topbar and calculator components
- **Version Reset**: Changed from V3.2.8 to 0.0.1-BETA
- **Support Functionality Removed**: 
  - Removed green support button from header
  - Removed support dialog with QR code and donation information
  - Removed `showDialog()` method from topbar component
  - Cleaned up version history to only show current beta version

## Core Architecture

### Main Calculation Flow
1. **Character Setup** → Job class selection, stat distribution, equipment
2. **Equipment Processing** → Item bonuses, cards, enchants, refining effects
3. **Skill Processing** → Active/passive skills, buffs, mastery bonuses
4. **Damage Calculation** → Physical/magical damage with elemental/size/race modifiers
5. **Result Display** → DPS, hit rates, critical chances, damage ranges

### Key Files & Components

#### Calculation Engine (`src/app/layout/pages/ro-calculator/`)
- **`calculator.ts`** (1,547 lines) - Master orchestrator
  - Equipment status calculation
  - Item bonus processing
  - Skill effect application
  - Final damage coordination
  
- **`damage-calculator.ts`** (1,447 lines) - Core damage logic
  - Physical/magical damage formulas
  - Elemental interaction calculations
  - Size penalty applications
  - Critical hit processing
  
- **`base-state-calculator.ts`** - Character base stats
- **`hp-sp-calculator.ts`** - HP/SP calculations

#### Job System (`src/app/jobs/`)
- **`_character-base.abstract.ts`** (622 lines) - Abstract foundation
  - Skill system interfaces (AtkSkillModel, ActiveSkillModel, PassiveSkillModel)
  - ASPD calculation framework
  - Job bonus systems
  - Mastery attack calculations

- **Individual Job Classes** (65+ files)
  - Each extends CharacterBase
  - Unique skill sets and bonuses
  - Job-specific damage calculations
  - Class mastery implementations

#### Game Data (`src/app/constants/`)
- **`skill-name.ts`** (667 lines) - Complete skill database
- **`item-type.enum.ts`** (230 lines) - Equipment categorization
- **`element-mapper.ts`** - Elemental damage tables
- **`size-penalty-mapper.ts`** - Monster size modifiers
- **`weapon-type-mapper.ts`** - Weapon classifications

#### Data Models (`src/app/models/`)
- **Character Models**: MainModel, StatusSummary, InfoForClass
- **Equipment Models**: EquipmentSummaryModel, ItemModel
- **Damage Models**: DamageSummaryModel, BasicDamageSummaryModel
- **Monster Models**: MonsterModel

#### API Services (`src/app/api-services/`)
- **`divine-pride.service.ts`** - External API integration for game data
  - Skill data retrieval from Divine Pride database
  - Monster information and spawn locations
  - Item properties and requirements
  - Server-specific data (defaults to bRO)
  - Environment-based authentication
- **API Models**: DivinePrideSkillModel, DivinePrideMonsterModel, DivinePrideItemModel
- **Integration**: HttpClient-based service with proper error handling

### Data Processing

#### Equipment System
- **Slots**: Weapon, Left Weapon, Armor, Shield, Garment, Boots, Accessories, Head Gears
- **Modifiers**: Refining levels (+0 to +20), Cards (4 slots), Enchants (3 levels)
- **Shadow Equipment**: Complete shadow gear system with separate calculations
- **Costume Equipment**: Costume pieces with enchantment support

#### Skill System Architecture
```typescript
interface AtkSkillModel {
  formula: (input: AtkSkillFormulaInput) => number;
  canCri?: boolean;
  isMatk?: boolean;
  element?: ElementType;
  hit?: number;
  maxStack?: number;
  // ... extensive skill properties
}
```

#### Damage Calculation Pipeline
1. **Base Damage** = Status ATK + Equipment ATK + Mastery ATK
2. **Skill Damage** = Base Damage × Skill Formula
3. **Elemental Modifier** = Damage × Element Table[attacker][defender]
4. **Size Modifier** = Damage × Size Penalty Table[weapon][monster]
5. **Final Damage** = (Modified Damage - DEF) × Final Multipliers

### Complex Systems

#### Multi-Element Support
- 10 elements: Neutral, Water, Earth, Fire, Wind, Poison, Holy, Dark, Ghost, Undead
- Dynamic property changing (Elemental Converter, Ammo)
- Element vs Element damage tables

#### Advanced Mechanics
- **Critical Hits**: Base critical + equipment bonuses + skill modifiers
- **ASPD Calculations**: Job-specific ASPD tables with weapon type modifiers
- **Combo Systems**: Equipment set bonuses and skill combinations
- **Buff Stacking**: Multiple buff effects with proper stacking rules

#### Monster Interaction
- **Race Types**: Demi-Human, Brute, Plant, Insect, Fish, Demon, Angel, Dragon, Undead
- **Size Categories**: Small, Medium, Large with weapon-specific penalties
- **Monster Stats**: DEF, MDEF, RES, MRES with calculation impacts

### UI Components (`src/app/layout/`)

#### Main Calculator Interface
- **`ro-calculator.component.ts`** (2,682 lines) - Main UI controller
- **Equipment Sections**: Organized equipment input panels
- **Status Display**: Real-time stat updates
- **Damage Output**: Comprehensive damage breakdown
- **Monster Selection**: Target monster database integration

#### Header/Navigation (Enhanced)
- **`app.topbar.component.ts`** - Clean topbar with consistent button styling
  - **Left Side**: Home button (regular pButton) + Bell icon (changelog notifications)
  - **Right Side**: Version display + Items search button + Settings cogwheel
  - **Icon Consistency**: All icons standardized to 1.25rem size via CSS rules
  - **Removed Tab Functionality**: Converted from p-tabMenu to regular buttons for consistency
  - Communication via LayoutService.itemSearchOpen$ and showConfigSidebar()

#### Footer (Enhanced)
- **`app.footer.component.ts`** - Enhanced footer with references integration
  - **Left Side**: Attribution to "NITROBLISSERINO ATTACK SQUAD @ ROLA" + Tong Calc credit
  - **Right Side**: References button with complete dialog functionality
  - **Dual References System**: References accessible from footer instead of cluttering navbar

#### Supporting Components
- **Item Search**: Equipment database search and filtering
- **Battle Summary**: Damage vs monster calculations
- **Elemental Tables**: Element interaction visualization

### Data Files (`src/assets/demo/data/`)
- **`item.json`** (8.7MB) - Complete item database with stats and bonuses
- **`monster.json`** (299KB) - Monster database with stats and properties
- **`hp_sp_table.json`** (286KB) - Character HP/SP progression tables
- **`x.json`** (10MB) - Extended game data and calculations

### Development Patterns

#### TypeScript Usage
- Extensive use of interfaces and type safety
- Generic types for equipment and skill systems
- Enum-based constants for game data
- Abstract classes for job inheritance

#### Angular Architecture
- Module-based organization
- Service injection for data management
- Reactive forms for character input
- PrimeNG for consistent UI components

#### Calculation Optimization
- Caching mechanisms for repeated calculations
- Efficient data structures (Maps, Sets)
- Modular calculation pipeline
- Memory-conscious large data handling

### Testing & Quality

#### Code Quality
- ESLint configuration for consistent code style
- TypeScript strict mode enabled
- Comprehensive interfaces for type safety
- Modular architecture for maintainability

#### Performance Considerations
- Large JSON file handling (20MB+ total data)
- Real-time calculation updates
- Memory management for character instances
- Efficient DOM updates in Angular

### Deployment

#### Build Process
- Angular production build optimization
- GitHub Pages deployment configuration
- Asset optimization and compression
- Hash-based routing for SPA compatibility

#### Environment Configuration
- Development/production environment settings
- Build-time constants and optimizations

### Key Algorithms

#### Damage Formula Core
```typescript
// Physical damage base calculation
const totalAtk = statusAtk + equipAtk + masteryAtk;
const skillDamage = totalAtk * skillFormula(skillLevel);
const elementalDamage = skillDamage * elementTable[attackElement][defenseElement];
const finalDamage = (elementalDamage - defense) * finalMultipliers;
```

#### ASPD Calculation
```typescript
// Attack speed calculation per job class
const baseAspd = AspdTable[jobClass][weaponType];
const totalAspd = baseAspd + (totalAgi * agiBonus) + (totalDex * dexBonus) + equipmentAspd;
const hitsPerSecond = totalAspd / 50; // RO ASPD formula
```

## Removed Features (Lean Architecture)

### Navigation Simplification
- **REMOVED**: Item Ranking feature and route (`/preset-summary`)
- **REMOVED**: Shared Presets feature and route (`/shared-presets`)
- **REMOVED**: Authentication system (login/logout, user profiles)
- **REMOVED**: External links (YouTube tutorials, issue tracking, surveys)
- **REMOVED**: Support functionality (green support button, donation dialog, QR code)
- **REMOVED**: References from navbar (moved to footer for cleaner navigation)

### Code Cleanup Benefits
- **Reduced Bundle Size**: ~10-15% smaller build + additional 11.73 kB reduction from tab removal
- **Simplified Maintenance**: Fewer dependencies and external integrations
- **Focused User Experience**: Single-purpose calculator interface with clean navigation
- **Language Consistency**: All Thai text translated to English
- **Clean Version History**: Reset to 0.0.1-BETA with simplified changelog
- **Icon Consistency**: Standardized all topbar icons to prevent future inconsistencies

### Preserved Core Functionality
- **Complete Damage Calculator**: All calculation engines intact
- **Job System**: All 65+ job classes fully functional
- **Equipment System**: Complete item database and processing
- **Monster Database**: Full monster interaction system
- **Technical References**: Documentation and formula sources maintained (now in footer)

## Future Development Notes

#### Extensibility Points
1. **New Job Classes**: Extend CharacterBase abstract class
2. **Additional Skills**: Add to _atkSkillList arrays with formula functions
3. **Equipment Types**: Extend ItemTypeEnum and related mappers
4. **Calculation Modifiers**: Add to damage calculation pipeline

#### Maintenance Areas
1. **Game Data Updates**: Item/monster database synchronization
2. **Formula Accuracy**: Damage calculation formula verification
3. **Performance Optimization**: Large data handling improvements
4. **UI/UX Enhancement**: Calculator interface improvements

#### Potential Further Optimizations
- Remove unused page modules (shared-preset, preset-summary, auth)
- Clean up unused assets and dependencies
- Consider removing unused translation infrastructure
- Evaluate removing unused PrimeNG components

This memory bank serves as a comprehensive guide for understanding and working with this streamlined, lean Ragnarok Online damage calculator codebase focused purely on core calculation functionality with a clean, consistent user interface.

#### UI Components (`src/app/layout/`)

##### Item Search Integration
- **`item-search.component.ts`** - Modified to remove fixed-position button
  - Removed fixed-position styling (was: `position: fixed; top: 42%; right: 0`)
  - Added `showDialog()` public method for external triggering
  - Integrated with LayoutService for topbar communication
- **`app.layout.service.ts`** - Enhanced with item search communication
  - Added `itemSearchOpen$` Subject for topbar-to-calculator communication
  - Added `showItemSearchDialog()` method to trigger item search from topbar

##### Settings Configuration
- **`app.config.component.html`** - Removed fixed-position button
  - Removed fixed-position cogwheel button (was: `layout-config-button` class)
  - Sidebar functionality preserved and accessible via topbar
  - Scale and color theme selection maintained

#### Calculator Integration
- **`ro-calculator.component.ts`** - Enhanced with topbar communication
  - Added `@ViewChild('itemSearchComponent')` reference to item search component
  - Added subscription to `layoutService.itemSearchOpen$` in ngOnInit
  - Triggers `itemSearchComponent.showDialog()` when topbar button is clicked

#### Icon Consistency System
- **CSS Standardization**: Implemented comprehensive icon sizing rules in `app.topbar.component.css`
  - All topbar icons forced to 1.25rem (text-xl equivalent) size
  - Future-proof rules prevent inconsistencies when adding new icons
  - Removed individual size classes from HTML templates
- **Button Consistency**: Converted all navigation elements to regular pButton components
  - Home button changed from p-tabMenu to pButton with routerLink
  - All buttons now follow identical structure and styling patterns
  - Removed unused MenuItem arrays and tab-related properties 